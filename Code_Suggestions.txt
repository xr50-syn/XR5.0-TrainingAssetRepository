Code_Suggestions

UsersProgressController.cs


        /// <summary>
        /// Get overall progress for a specific user
        /// GET /api/{tenantName}/users/{userId}/progress
        /// </summary>
        [HttpGet("~/api/{tenantName}/users/{userId}/progress")]
        [Authorize]
        public async Task<ActionResult<UserProgressResponse>> GetUserProgressByUserId(
            string tenantName,
            string userId)
        {
            try
            {
                if (string.IsNullOrEmpty(userId))
                {
                    return BadRequest(new { error = "userId is required" });
                }

                var result = await _userMaterialService.GetUserProgressAsync(userId);
                return Ok(result);
            }
            catch (ArgumentException ex)
            {
                _logger.LogWarning(ex, "User not found");
                return NotFound(new { error = ex.Message });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting user progress");
                return StatusCode(500, new { error = "Failed to get progress" });
            }
        }

        /// <summary>
        /// Get overall progress for all users
        /// GET /api/{tenantName}/users/progress
        /// </summary>
        [HttpGet("~/api/{tenantName}/users/progress")]
        [Authorize]
        public async Task<ActionResult<List<UserProgressResponse>>> GetAllUsersProgress(
            string tenantName)
        {
            try
            {
                var result = await _userMaterialService.GetAllUsersProgressAsync();
                return Ok(result);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error getting all users progress");
                return StatusCode(500, new { error = "Failed to get users progress" });
            }
        }


IUserMaterialService.cs

        /// <summary>
        /// Get overall progress for a user including all programs and standalone materials
        /// </summary>
        Task<UserProgressResponse> GetUserProgressAsync(string userId);

        /// <summary>
        /// Get overall progress for all users including all programs and standalone materials
        /// </summary>
        Task<List<UserProgressResponse>> GetAllUsersProgressAsync();

UserMaterialService.cs

public async Task<UserProgressResponse> GetUserProgressAsync(string userId)
        {
            using var context = _dbContextFactory.CreateDbContext();

            var user = await context.Users.FirstOrDefaultAsync(u => u.UserName == userId);
            if (user == null)
            {
                throw new ArgumentException($"User {userId} not found");
            }

            // Get all user scores
            var userScores = await context.UserMaterialScores
                .Where(ums => ums.UserId == userId)
                .ToListAsync();

            // Get programs the user has progress in
            var programIds = userScores
                .Where(s => s.ProgramId.HasValue)
                .Select(s => s.ProgramId!.Value)
                .Distinct()
                .ToList();

            var programs = await context.TrainingPrograms
                .Where(p => programIds.Contains(p.id))
                .Include(p => p.Materials)
                    .ThenInclude(pm => pm.Material)
                .ToListAsync();

            var programProgressList = new List<ProgramProgressDto>();

            foreach (var program in programs)
            {
                var programScores = userScores
                    .Where(s => s.ProgramId == program.id)
                    .ToList();

                var totalMaterials = program.Materials?.Count ?? 0;
                var completedMaterials = programScores.Count;
                var programProgress = totalMaterials > 0
                    ? (int)Math.Round((double)completedMaterials / totalMaterials * 100)
                    : 0;

                var materialScores = new List<MaterialScoreDto>();
                if (program.Materials != null)
                {
                    foreach (var pm in program.Materials)
                    {
                        var score = programScores.FirstOrDefault(s => s.MaterialId == pm.MaterialId);
                        materialScores.Add(new MaterialScoreDto
                        {
                            id = pm.MaterialId.ToString(),
                            name = pm.Material?.Name ?? "",
                            type = pm.Material?.Type.ToString() ?? "",
                            score = score?.Score ?? 0,
                            completed = score != null
                        });
                    }
                }

                programProgressList.Add(new ProgramProgressDto
                {
                    id = program.id.ToString(),
                    name = program.Name,
                    progress = programProgress,
                    materials = materialScores
                });
            }

            // Get standalone materials (no program)
            var standaloneMaterialIds = userScores
                .Where(s => !s.ProgramId.HasValue)
                .Select(s => s.MaterialId)
                .ToList();

            var standaloneMaterials = await context.Materials
                .Where(m => standaloneMaterialIds.Contains(m.id))
                .ToListAsync();

            var standaloneProgressList = standaloneMaterials.Select(m =>
            {
                var score = userScores.FirstOrDefault(s => s.MaterialId == m.id && !s.ProgramId.HasValue);
                return new StandaloneMaterialProgressDto
                {
                    id = m.id.ToString(),
                    name = m.Name,
                    type = m.Type.ToString(),
                    score = score?.Score ?? 0
                };
            }).ToList();

            // Calculate overall progress
            var totalCompleted = userScores.Count;
            var overallProgress = totalCompleted > 0 ? 100 : 0; // Simplified overall progress

            return new UserProgressResponse
            {
                id = userId,
                name = user.FullName ?? user.UserName,
                progress = overallProgress,
                programs = programProgressList,
                standalone_materials = standaloneProgressList
            };
        }
        public async Task<List<UserProgressResponse>> GetAllUsersProgressAsync()
        {
            using var context = _dbContextFactory.CreateDbContext();

            var users = await context.Users
                .Select(u => u.UserName)
                .ToListAsync();

            var result = new List<UserProgressResponse>();

            foreach (var userId in users)
            {
                var progress = await GetUserProgressAsync(userId);
                result.Add(progress);
            }

            return result;
        }